<!DOCTYPE html>
<html lang="ko">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="description" content="여행과 기술을 연결하고, 사용자와 여행을 이어주는 스퀘어랩만의 노하우를 확인해 보세요.">
  <meta name="msapplication-TileColor" content="#782bde">
  <meta name="theme-color" content="#ffffff">
  <meta name="google-site-verification" content="-kdxteMBSgKizw-6qHNm1-5nfxb7H6947J64jmjbBEg" />

  <meta property="og:site_name" content="Square Lab 블로그">
  <meta property="og:title" content="말 안 듣는 this, Typescript Custom ESLint Rule로 혼내주기">
  <meta property="og:description" content="Nest.JS 기반의 서버를 개발하면서, 코드 작성시 실수 하기 쉬웠던 부분이 있었습니다. Javascript의 this 가 예상하지 않은 object를 가리킬 수도 있는 코드를 작성하게 되는 경우였는데요....">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://squarelab.co/blog/custom-typescript-eslint-rule/">
  <meta property="og:image" content="https://squarelab.co/images/blog/ts-custom-eslint-plugin/cover.png">

  <title>말 안 듣는 this, Typescript Custom ESLint Rule로 혼내주기</title>

  <link rel="stylesheet" type="text/css" href="/css/blog.css">
  <link rel="stylesheet" type="text/css" href="/css/footer.css">
  <link rel="stylesheet" type="text/css" href="/css/zoom.css">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" rel="stylesheet">
  <link href='https://spoqa.github.io/spoqa-han-sans/css/SpoqaHanSansNeo.css' rel='stylesheet' type='text/css'>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/default.min.css" rel="stylesheet" >

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  출처: https://uxgjs.tistory.com/102 [UX 공작소]
  <script src="/js/zoom.js"></script>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-XPY973PH6D"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-XPY973PH6D');
  </script>
</head>
  <body>
  <header id="blog-header" class="header">
    <div class="blog-header-container">
        <a href="/blog">
          <img src="/images/squarelab-bi-blog.png" width="200" class="bi-blog" alt="스퀘어랩 기술블로그 로고">
        </a>
        <a href="/"><i class="ri-home-4-line"></i></a>
    </div>
</header>
  <div class="blog-container">
    <div class="blog-top" style="background-image:url(/images/blog/ts-custom-eslint-plugin/cover.png); background-size: cover;" >
        <div class="overlay">
            <div class="title-container">
                <span class="category">Engineering</span>
                <h1 class="ctitle-top">말 안 듣는 this, Typescript Custom ESLint Rule로 혼내주기</h1>
                <div class="author">
                    <img class="img-author-2" src="/images/blog/author/seongbin.png">
                    <small class="small-top" >성빈</small><small>|</small><small name="locale-date">Oct 31, 2023</small>
                </div>
            </div>
        </div>
    </div>
    <div class="blog-row">
        <div class="post">
            <p>Nest.JS 기반의 서버를 개발하면서, 코드 작성시 실수 하기 쉬웠던 부분이 있었습니다. Javascript의 <code class="highlighter-rouge">this</code> 가 예상하지 않은 object를 가리킬 수도 있는 코드를 작성하게 되는 경우였는데요. 특정 경우에 발생할 수 있는 <code class="highlighter-rouge">this</code> 로 인한 버그를 typescript custom eslint rule을 제작하여 방지해보고자 했습니다.</p>

<h2 id="custom-rule-개발의-필요성">Custom Rule 개발의 필요성</h2>

<p>아래와 같은 코드를 한번 확인해볼까요?</p>

<h3 id="사례-1">사례 1.</h3>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">Clock</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">currentTime</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">12:00 PM</span><span class="dl">"</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">showTime</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">currentTime</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">myClock</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Clock</span><span class="p">();</span>
<span class="nx">setTimeout</span><span class="p">(</span><span class="nx">myClock</span><span class="p">.</span><span class="nx">showTime</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span> <span class="c1">// After 1 second, this logs: `undefined`.</span>
</code></pre></div></div>

<p><strong>사례 1</strong>은 <code class="highlighter-rouge">myClock.showTime</code> 이라는 함수를 <code class="highlighter-rouge">setTimeout</code> 이라는 함수의 parameter로 넘겨주는 형태로 인해 생기는 버그입니다.
이를 방지하려면, <code class="highlighter-rouge">setTimeout(() =&gt; myClock.showTime(), 1000)</code> 혹은 <code class="highlighter-rouge">setTimeout(myClock.showTime.bind(myClock), 1000)</code> 와 같이 <code class="highlighter-rouge">this</code> 가 호출될 때, 그 context를 잘 찾도록 해줘야합니다.</p>

<h3 id="사례-2">사례 2.</h3>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">CoffeeMachine</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">discountTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">discountTime</span> <span class="o">=</span> <span class="nx">discountTime</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">makeEspresso</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Making Espresso in:</span><span class="dl">"</span><span class="p">,</span> <span class="mi">2</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">discountTime</span><span class="p">,</span> <span class="dl">"</span><span class="s2">minutes.</span><span class="dl">"</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">makeLatte</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Making Latte in:</span><span class="dl">"</span><span class="p">,</span> <span class="mi">5</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">discountTime</span><span class="p">,</span> <span class="dl">"</span><span class="s2">minutes.</span><span class="dl">"</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nx">Barista</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">machine</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">machine</span> <span class="o">=</span> <span class="nx">machine</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">coffeeMakingTimeMap</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">Espresso</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">machine</span><span class="p">.</span><span class="nx">makeEspresso</span><span class="p">,</span>
      <span class="na">Latte</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">machine</span><span class="p">.</span><span class="nx">makeLatte</span><span class="p">,</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="nx">orderCoffee</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">coffeeMakingTimeMap</span><span class="p">[</span><span class="nx">type</span><span class="p">]();</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">machine</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CoffeeMachine</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">john</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Barista</span><span class="p">(</span><span class="nx">machine</span><span class="p">);</span>
<span class="nx">john</span><span class="p">.</span><span class="nx">orderCoffee</span><span class="p">(</span><span class="dl">"</span><span class="s2">Espresso</span><span class="dl">"</span><span class="p">);</span> <span class="c1">// Logs: "Making Espresso in: NaN minutes."</span>
</code></pre></div></div>

<p><strong>사례 2</strong>는 <code class="highlighter-rouge">Barista</code> 의 <code class="highlighter-rouge">this.coffeeMakingTimeMap</code> 에서 <code class="highlighter-rouge">Machine</code> 의 <code class="highlighter-rouge">makeEspresso</code> , <code class="highlighter-rouge">makeLatte</code> 함수 자체를 값으로 주다보니 생기는 버그입니다.
여기서도 <code class="highlighter-rouge">() =&gt; this.machine.makeEspresso()</code> / <code class="highlighter-rouge">() =&gt; this.machine.makeLatte()</code> 와 같이 넘겨주어야 <code class="highlighter-rouge">this</code> 가 우리가 의도한대로 찾아집니다.</p>

<p>사례 1에서처럼 단순히 <code class="highlighter-rouge">myClock.showTime</code> 을 인자로 넘겨버리게 되면, <code class="highlighter-rouge">this</code> 가 브라우저 환경에서는 <code class="highlighter-rouge">window</code> 객체를, NodeJS 환경에서는 <code class="highlighter-rouge">global</code> 객체를 가리키게 되어, 예시 코드에서처럼 <code class="highlighter-rouge">undefined</code> 가 출력되게 됩니다.</p>

<p>Javascript에서는 함수가 어떻게 호출되는지에 따라서 <code class="highlighter-rouge">this</code>가 동적으로 결정되기 때문에, <code class="highlighter-rouge">Arrow Function</code> 형태로 호출하면, Lexical Context 안의 <code class="highlighter-rouge">this</code>를 가지도록 할 수 있습니다.</p>

<p>그래서 원치 않는 동작으로부터 방지하기 위해, 어떤 함수를 함수의 인자로 넘길 때에는, <code class="highlighter-rouge">arrow function</code> 형태, 혹은 <code class="highlighter-rouge">this</code>를 명시적으로 바인드 해준 형태로 넘겨주도록 하는 ESLint Rule을 만들어보기로 했습니다. 이런 Rule을 누군가 만들어놨을 법 한데, 못 찾겠더라구요. 😭</p>

<hr />

<h2 id="eslint">ESLint</h2>

<p>JS 기반 프로젝트에서는 ESLint Rule을 적용함으로써 프로젝트의 코드 품질을 향상시키고, 코딩 컨벤션을 일치함으로써 팀원간의 협업을 용이하게 할 수 있습니다. 단순히 이런 이점이 있음을 아는 것도 충분하다고 생각하지만, ESLint가 어떤식으로 특정 Rule을 검사해내는지 원리를 이해한다면, 우리 팀이나 프로젝트에 알맞는 Rule을 만들어낼 수도 있을 것입니다.</p>

<blockquote>
  <p>그러나, 우리가 주로 사용할 유용한 rule 들은 대부분 이미 만들어져있으므로, 스스로 직접 만들기보다는 기존에 존재하는 Rule들을 찾아보고, 이들을 어떻게 조합해서 사용할 수 있을지를 알아보는 것이 시간을 많이 아낄 수 있을 것입니다. 🫠</p>
</blockquote>

<blockquote>
  <p>ESLint에서 기본적으로 정말 많은 Rule을 제공합니다. (<a href="https://eslint.org/docs/latest/rules/">링크</a>)</p>
</blockquote>

<h3 id="ast">AST</h3>

<p>우리가 작성한 JS 코드는 V8 엔진의 컴파일러에 의해 파싱 과정을 거쳐 AST(Abstract Syntax Tree)가 생성되고, 이는 바이트 코드로 변환됩니다. 아래 이미지는 <a href="https://v8.dev/blog/background-compilation">V8 엔진의 바이트코드 컴파일러가 어떻게 작동하는지</a>를 설명한 그림입니다.
<img src="https://v8.dev/_img/background-compilation/bytecode.svg" alt="JS AST" />
우리는 프로젝트에서 ESLint를 사용함으로써, V8 엔진이 코드를 컴파일하기 이전에 미리 AST를 만들어보고, 여기서 Rule에 맞지 않는 문법을 검사 해볼 수 있습니다.</p>

<p><a href="https://astexplorer.net/">AST Explorer</a> 에서 Javascript 코드를 입력해보면, 우측에 Tree 탭에서 현재 커서가 위치하는 곳이 AST 내부에서 어떤 노드에 해당하는지를 확인해볼 수 있습니다.
위 이미지에서의 예시를 그대로 한번 입력해보겠습니다.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">f</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">a</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>그 결과 생성된 AST는 아래와 같이 시작합니다.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Program"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"start"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
  </span><span class="nl">"end"</span><span class="p">:</span><span class="w"> </span><span class="mi">83</span><span class="p">,</span><span class="w">
  </span><span class="nl">"body"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"FunctionDeclaration"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"start"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
      </span><span class="nl">"end"</span><span class="p">:</span><span class="w"> </span><span class="mi">83</span><span class="p">,</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Identifier"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"start"</span><span class="p">:</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w">
        </span><span class="nl">"end"</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w">
        </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"f"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"expression"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
      </span><span class="nl">"generator"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
      </span><span class="nl">"async"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
      </span><span class="nl">"params"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Identifier"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"start"</span><span class="p">:</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w">
          </span><span class="nl">"end"</span><span class="p">:</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w">
          </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"a"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="err">//</span><span class="w"> </span><span class="err">...</span><span class="w">
</span></code></pre></div></div>

<p>함수를 선언하는 부분의 type은 <code class="highlighter-rouge">FunctionDeclaration</code> 으로, 그 함수의 이름을 <code class="highlighter-rouge">f</code> 로 지정하는 부분의 type은 <code class="highlighter-rouge">Identifier</code> 로, 그리고 이 함수의 parameter의 type은 <code class="highlighter-rouge">Identifier</code> 이고 그 이름은 <code class="highlighter-rouge">a</code> 로 잘 파싱되어있네요.</p>

<h3 id="이걸로-어떻게-custom-rule을-만드나요">이걸로 어떻게 Custom Rule을 만드나요?</h3>

<p>우리는 이 구조를 활용해서 우리가 원하는 ESLint Rule을 작성할 수 있습니다.
만약 우리가 “함수의 이름은 반드시 소문자로 시작해야한다” 와 같은 Rule을 만들고 싶다면, 어떤 식으로 이 Rule을 만들어볼 수 있을까요?
AST에서 타입이 <code class="highlighter-rouge">FunctionDeclaration</code>인 노드를 찾고, 이 노드의 id의 <code class="highlighter-rouge">name</code>의 첫번째 글자가 소문자인지를 확인하면 될 것입니다.</p>

<p>AST를 탐색하는 과정에는 <a href="https://estools.github.io/esquery/"><code class="highlighter-rouge">esquery</code></a> 를 사용할 수 있습니다. <code class="highlighter-rouge">esquery</code>는 CSS 셀렉터랑 유사한 문법을 사용해서 AST 노드를 선택하는 것을 가능하게 해줍니다.
그렇다면 우리는 <code class="highlighter-rouge">esquery</code> 를 사용할 때, Javascript 문법의 각 요소들이 어떤 타입의 노드로 파싱되는지를 알아야할 것입니다. <a href="https://github.com/estree/estree/blob/master/README.md">estree repository</a> 에서 해당 내용을 확인해볼 수 있습니다.</p>

<p>AST가 어떻게 생성되는지 익숙하지 않으신 분들에게는, 검출해내기 원하는 문법을 <a href="https://astexplorer.net/">AST Explorer</a> 에 입력해보고, 내가 알고 싶은 부분의 노드 타입이 부모 노드와, 혹은 자식 노드와 어떤 관계에 있는지를 직접 확인해보는게 좋을 것 같습니다.</p>

<h3 id="esquery">esquery</h3>

<p><strong>사례 1</strong>의 코드를 그대로 AST Explorer에 입력해보고, <code class="highlighter-rouge">myClock.showTime</code> 과 같은 형태가 어떤 type의 Node인지 확인해보면, <code class="highlighter-rouge">CallExpression</code>의 <code class="highlighter-rouge">argument</code>들 중에서, <code class="highlighter-rouge">MemberExpression</code> 으로 선언 되었네요.
esquery로 검출해보려면 다음과 같이 작성할 수 있겠습니다.</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CallExpression &gt; MemberExpression
</code></pre></div></div>

<p>이 때, 내가 작성한 esquery가 잘 작동하는지를 확인해보고 싶다면, <a href="https://estools.github.io/esquery/">이곳</a>에서 JS 코드와, esquery를 작성한 후, 해당 노드가 잘 찾아지는지를 확인해보면 됩니다.</p>

<p>위의 <code class="highlighter-rouge">esquery</code>에는 함정이 있는데요, 우리가 원한 <code class="highlighter-rouge">myClock.showTime</code> 뿐만이 아니라, <code class="highlighter-rouge">console.log</code> 와<code class="highlighter-rouge">this.currentTime</code> 까지 모두 검출해버렸습니다. ESLint의 한계를 마주하게 되는 지점입니다. Javascript 만으로는 이 이상 검출해낼 수는 없습니다.</p>

<p>만약 Typescript로 코드를 작성했다면, 타입을 활용해서 검출할 수 있으면 좋겠다는 생각이 자연스럽게 드는 지점입니다. 다행히도, Typescript와 ESLint 를 조합하여 Rule을 만들어낼 수 있었습니다.</p>

<h3 id="typescript-eslint"><a href="https://github.com/typescript-eslint">Typescript-ESLint</a></h3>

<p>Typescript-eslint 는 ESLint가 Typescript에서도 사용할 수 있도록 하는 플러그인입니다. <a href="https://typescript-eslint.io/developers/custom-rules/">typescript-eslint custome rule 문서</a> 에서 는 ESLint의 <code class="highlighter-rouge">parser</code>로 <code class="highlighter-rouge">@typescript-eslint/parser</code> 를 사용하여 <code class="highlighter-rouge">Typed Rule</code> 을 작성하는 방법을 확인할 수 있습니다.
기본적으로 <code class="highlighter-rouge">esquery</code>를 사용하여 원하는 노드를 검출해낸 후에, <code class="highlighter-rouge">@typescript-eslint/utils</code>의 <code class="highlighter-rouge">ESLintUtils</code> 를 사용하여 TypeScript의 type checker API 를 호출하는 과정을 거치면 됩니다.
TypeScript는 어떤 식으로 AST를 생성하는지에 대해서는 위에서 나온 AST Explorer와 비슷한 형태인 <a href="https://ts-ast-viewer.com/">TypeScript AST Viewer</a>를 활용하면서 많은 도움을 받았습니다.</p>

<hr />

<h2 id="custom-plugin-개발">Custom Plugin 개발</h2>

<p>ESLint에서 <code class="highlighter-rouge">Rule</code>은 <code class="highlighter-rouge">Plugin</code> 안에 포함되어있는 구조입니다. 우리가 만들고 싶은 Rule들을 Plugin안에 집어넣고, 해당 Plugin을 NPM과 같은 사이트에 publish 한다면, 다른 사람들도 우리가 작성한 Rule을 사용할 수 있을거에요.</p>

<p>글 초반부에 나온 <strong>사례 1</strong>과 <strong>사례 2</strong>를 방지하기 위한 Rule을 <code class="highlighter-rouge">no-direct-class-method-passing</code>, <code class="highlighter-rouge">no-direct-class-method-referencing</code> 로 각각 명명하여 개발했습니다.
두 가지의 Rule로 나누게 된 이유는, 각각의 사례를 검출해내기 위한 <code class="highlighter-rouge">esquery</code>가 다르고, 타입을 검사하는 방식도 일부 달랐기 때문이었습니다.</p>

<h3 id="custom-plugin-구조">Custom plugin 구조</h3>

<p>최종적으로 구조는 아래와 같습니다.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.
├── README.md
├── index.js
├── lib
│   ├── rules
│   │   ├── no-direct-class-method-passing.js
│   │   └── no-direct-class-method-referencing.js
│   └── util.js
├── package.json
├── test
│   ├── fixture
│   │   ├── file.ts
│   │   └── tsconfig.json
│   ├── no-direct-class-method-passing.test.js
│   └── no-direct-class-method-referencing.test.js
└── yarn.lock
</code></pre></div></div>

<ul>
  <li><code class="highlighter-rouge">index.js</code> 에는 플러그인이 어떻게 구성되어있는지를 나타냅니다.</li>
</ul>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">configs</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">recommended</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">plugins</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">tidesquare</span><span class="dl">"</span><span class="p">],</span>
      <span class="na">parser</span><span class="p">:</span> <span class="dl">"</span><span class="s2">@typescript-eslint/parser</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">parserOptions</span><span class="p">:</span> <span class="p">{</span> <span class="na">sourceType</span><span class="p">:</span> <span class="dl">"</span><span class="s2">module</span><span class="dl">"</span> <span class="p">},</span>
      <span class="na">rules</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">tidesquare/no-direct-class-method-passing</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">error</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">tidesquare/no-direct-class-method-referencing</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">error</span><span class="dl">"</span><span class="p">,</span>
      <span class="p">},</span>
    <span class="p">},</span>
  <span class="p">},</span>
  <span class="na">rules</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">no-direct-class-method-passing</span><span class="dl">"</span><span class="p">:</span> <span class="nx">noDirectClassMethodPassing</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">no-direct-class-method-referencing</span><span class="dl">"</span><span class="p">:</span> <span class="nx">noDirectClassMethodReferencing</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">};</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">configs</code> 에는 어떤 rule들을 enable 시킬 것인지를 미리 나타낸 조합이라고 보시면 됩니다.
만약 어떤 사용자가 자신의 프로젝트에서 이 플러그인의 <code class="highlighter-rouge">recommended</code> config를 사용한다면, 각각의 rule을 위반하는 코드가 검출된다면 모두 <code class="highlighter-rouge">error</code> 인 상태로 사용하겠다는 것을 의미합니다. 꼭 config를 사용하지 않더라도, 각각의 rule을 사용할지 안할지를 명시해주면 됩니다. (<a href="https://eslint.org/docs/latest/use/configure/plugins">참고</a>)</p>

<blockquote>
  <p>ESLint plugin의 이름은 <code class="highlighter-rouge">eslint-plugin-XYZ</code> 와 같이 정의됩니다. 이 플러그인을 프로젝트에서 사용하기 위해서는 <code class="highlighter-rouge">.eslintrc</code> 와 같은 파일 내의 <code class="highlighter-rouge">plugins</code> 목록에 <code class="highlighter-rouge">XYZ</code> 만 추가해도<code class="highlighter-rouge">eslint-plugin-XYZ</code> 를 사용하는 것으로 인식합니다. (<a href="https://eslint.org/docs/latest/extend/plugins#name-a-plugin">참고</a>)</p>
</blockquote>

<h4 id="librules">lib/rules</h4>

<ul>
  <li>
    <p><code class="highlighter-rouge">lib/rules</code> 내부에는 사례1, 2 발생을 방지하는 Rule에 대한 스펙을 각각 작성했습니다.</p>
  </li>
  <li>
    <p><strong>사례 1</strong>을 방지하는 <code class="highlighter-rouge">no-direct-class-method-passing</code> Rule 코드를 한번 살펴보겠습니다.</p>
  </li>
</ul>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">{</span> <span class="nx">ESLintUtils</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">@typescript-eslint/utils</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">ts</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">typescript</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">createRule</span> <span class="o">=</span> <span class="nx">ESLintUtils</span><span class="p">.</span><span class="nx">RuleCreator</span><span class="p">(</span>
  <span class="nx">name</span> <span class="o">=&gt;</span> <span class="s2">`https://www.npmjs.com/package/eslint-plugin-tidesquare`</span><span class="p">,</span>
<span class="p">)</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">rule</span> <span class="o">=</span> <span class="nx">createRule</span><span class="p">({</span>
  <span class="nx">create</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">CallExpression</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">services</span> <span class="o">=</span> <span class="nx">ESLintUtils</span><span class="p">.</span><span class="nx">getParserServices</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span>
        <span class="kd">const</span> <span class="nx">typeChecker</span> <span class="o">=</span> <span class="nx">services</span><span class="p">.</span><span class="nx">getTypeAtLocation</span>
          <span class="p">?</span> <span class="nx">services</span>
          <span class="p">:</span> <span class="nx">services</span><span class="p">.</span><span class="nx">program</span><span class="p">.</span><span class="nx">getTypeChecker</span><span class="p">()</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">argument</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="kd">const</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">typeChecker</span><span class="p">.</span><span class="nx">getTypeAtLocation</span><span class="p">(</span><span class="nx">argument</span><span class="p">)</span>
          <span class="nx">type</span><span class="p">?.</span><span class="nx">symbol</span><span class="p">?.</span><span class="nx">declarations</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">declaration</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">declaration</span><span class="p">.</span><span class="nx">kind</span> <span class="o">===</span> <span class="nx">ts</span><span class="p">.</span><span class="nx">SyntaxKind</span><span class="p">.</span><span class="nx">MethodDeclaration</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">context</span><span class="p">.</span><span class="nx">report</span><span class="p">({</span>
                <span class="na">node</span><span class="p">:</span> <span class="nx">argument</span><span class="p">,</span>
                <span class="na">messageId</span><span class="p">:</span> <span class="dl">'</span><span class="s1">noDirectClassMethodPassing</span><span class="dl">'</span><span class="p">,</span>
                <span class="nx">fix</span><span class="p">(</span><span class="nx">fixer</span><span class="p">)</span> <span class="p">{</span>
                  <span class="kd">const</span> <span class="nx">sourceCode</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">getSourceCode</span><span class="p">()</span>
                  <span class="kd">const</span> <span class="nx">argument</span> <span class="o">=</span> <span class="nx">sourceCode</span><span class="p">.</span><span class="nx">getText</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
                  <span class="kd">const</span> <span class="nx">parametersLength</span> <span class="o">=</span> <span class="nx">type</span><span class="p">?.</span><span class="nx">symbol</span><span class="p">?.</span><span class="nx">declarations</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">parameters</span><span class="p">?.</span><span class="nx">length</span> <span class="o">??</span> <span class="mi">0</span>
                  <span class="kd">const</span> <span class="nx">parameters</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="k">from</span><span class="p">({</span> <span class="na">length</span><span class="p">:</span> <span class="nx">parametersLength</span> <span class="p">})</span>
                    <span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">_</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="s2">`$</span><span class="p">${</span><span class="nx">i</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
                    <span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="dl">'</span><span class="s1">,</span><span class="dl">'</span><span class="p">)</span>
                  <span class="kd">const</span> <span class="nx">fixedCode</span> <span class="o">=</span> <span class="s2">`(</span><span class="p">${</span><span class="nx">parameters</span><span class="p">}</span><span class="s2">) =&gt; </span><span class="p">${</span><span class="nx">argument</span><span class="p">}</span><span class="s2">(</span><span class="p">${</span><span class="nx">parameters</span><span class="p">}</span><span class="s2">)`</span>
                  <span class="k">return</span> <span class="nx">fixer</span><span class="p">.</span><span class="nx">replaceText</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">fixedCode</span><span class="p">)</span>
                <span class="p">},</span>
	<span class="c1">// ...</span>
  <span class="p">},</span>
  <span class="na">meta</span><span class="p">:</span> <span class="p">{</span>
    <span class="c1">// 메타 정보</span>
    <span class="na">messages</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">noDirectClassMethodPassing</span><span class="p">:</span> <span class="dl">'</span><span class="s1">에러 메시지</span><span class="dl">'</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="na">fixable</span><span class="p">:</span> <span class="dl">'</span><span class="s1">code</span><span class="dl">'</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="na">defaultOptions</span><span class="p">:</span> <span class="p">[],</span>
<span class="p">})</span>
</code></pre></div></div>

<ul>
  <li><code class="highlighter-rouge">CallExpression</code>들에 대해, <code class="highlighter-rouge">arguments</code> 마다 타입이 <code class="highlighter-rouge">MethodDeclaration</code> 인지를 확인하고, 에러상황일 경우 <code class="highlighter-rouge">report</code> 합니다.</li>
  <li><code class="highlighter-rouge">fix</code> 옵션이 주어질 경우, <code class="highlighter-rouge">fixedCode</code>를 생성해서 해당 부분을 고칠 수 있습니다.</li>
</ul>

<p><br /></p>

<blockquote>
  <p><strong>Typescript로 rule을 제작하지 않은 이유는 아래와 같습니다.</strong></p>

  <ol>
    <li>프로젝트에서 Type checking이 enable 되었는지 여부에 따라, <code class="highlighter-rouge">ESLintUtils.getParserServices()</code> 의 내부에 <code class="highlighter-rouge">getTypeAtLocation</code> / <code class="highlighter-rouge">getSymbolAtLocation</code> 이 존재하는지 여부를 확인할 수 있는데, 타입 선언 된 파일을 보면 기본적으로 이 함수들이 존재하지 않음을 가정합니다.</li>
    <li>주어진 context 내에서 node에 접근하는 과정에서 매번 type을 단언해줘야하다보니, Typescript의 강점을 제대로 활용하기 어려웠습니다.</li>
  </ol>
</blockquote>

<p><br /></p>

<ul>
  <li><strong>사례 1</strong>과 비슷한 방식으로, <strong>사례 2</strong> 를 방지하는 Rule을 만들 때 <code class="highlighter-rouge">esquery</code>는 다음과 같이 작성할 수 있었습니다.
<code class="highlighter-rouge">CallExpression</code>이나 <code class="highlighter-rouge">TaggedTemplateExpression</code> 이 아니면서, children이 <code class="highlighter-rouge">MemberExpression</code> 인 노드를 골라야합니다.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>':not(CallExpression, TaggedTemplateExpression) &gt; MemberExpression[property.type="Identifier"]'
</code></pre></div></div>

<ul>
  <li>위에서 <code class="highlighter-rouge">TaggedTemplateExpression</code> 이 있는 이유는, 아래와 같은 코드를 정상이라고 판단하기 위해서 입니다.</li>
</ul>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">this</span><span class="p">.</span><span class="nx">prisma</span><span class="p">.</span><span class="nx">$excuteRaw</span><span class="s2">`SELECT * FROM database`</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="test-작성">Test 작성</h3>

<p>우리가 작성하는 Rule은 Javascript AST 만 검사하는 것이 아니라, type check 까지 해야하기 때문에, Typescript가 실행되는 환경을 제공해야합니다.
<code class="highlighter-rouge">text/fixture/file.ts</code> 는 아무 내용도 없는 빈 파일입니다. 이 파일에는 테스트 실행시 우리가 테스트 하고 싶은 Typescript 코드가 입력되고, 우리가 작성한 type checking rule을 ESLint가 직접 돌려보는 식으로 테스트가 진행됩니다.</p>

<p>저는 Testing Library로 <code class="highlighter-rouge">mocha</code>를 선택했고, <code class="highlighter-rouge">mocha</code>에 의해 테스트를 실행하려면 테스트 코드 파일에 아래와 같은 내용 작성이 필요했습니다.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">{</span> <span class="nx">RuleTester</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">@typescript-eslint/rule-tester</span><span class="dl">"</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">mocha</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">mocha</span><span class="dl">"</span><span class="p">);</span>

<span class="nx">RuleTester</span><span class="p">.</span><span class="nx">afterAll</span> <span class="o">=</span> <span class="nx">mocha</span><span class="p">.</span><span class="nx">after</span><span class="p">;</span>
</code></pre></div></div>

<blockquote>
  <p>기존에 프로젝트에서 사용하던 Typescript version을 올릴 수 밖에 없었는데, 5.0 이상으로 버전을 올리게 되면, Nest.JS 프로젝트에서 decorator를 사용하여 의존성을 주입하고 있는 부분의 일부 코드가 깨지는 경우가 생겨서, 4 버전 중 가장 최신 버전으로까지만 올릴 수 있었습니다.</p>
</blockquote>

<hr />

<h2 id="완성한-rule의-한계">완성한 Rule의 한계</h2>

<p><code class="highlighter-rouge">this</code> 가 context 를 잃어버리는 모든 상황을 이제 다 방지할 수 있을 것이다는 희망을 가질 수도 있지만,, 현재 이 Rule에는 한계가 존재하는 상황입니다.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">domCancelPnr</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">domCancelPnr</span> <span class="k">as</span> <span class="p">(</span>
  <span class="nx">request</span><span class="p">:</span> <span class="nx">IDomCancelPnrRequest</span><span class="p">,</span>
  <span class="nx">options</span><span class="p">:</span> <span class="p">{</span> <span class="nl">deadline</span><span class="p">?:</span> <span class="kr">number</span> <span class="p">}</span>
<span class="p">)</span> <span class="o">=&gt;</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">DomCancelPnrResponse</span><span class="o">&gt;</span><span class="p">;</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">this.client.domCancelPnr</code> 라는 함수의 파라미터 타입을 <code class="highlighter-rouge">as</code> 키워드를 사용하여 변경하고, 그렇게 변경한 타입의 함수를 사용하는 경우입니다.
<code class="highlighter-rouge">this.client.domCancelPnr</code> 를 <code class="highlighter-rouge">domCancelPnr</code> 이라는 변수로 타입을 재정의하여 사용하려는 의도가 있는 코드입니다. 이는 <strong>사례 2</strong>를 방지하기 위한 <code class="highlighter-rouge">no-direct-class-method-referencing</code> Rule을 위반하게 됩니다. 이런 경우는 어떻게 처리하면 좋을까요?
<code class="highlighter-rouge">as</code> 라는 키워드로 타입이 단언되어있을 경우에는 해당 Rule을 위반하지 않도록 rule에 option을 부여하는 식으로 해결할 수도 있을 것이고, 아예 다른 방식으로 구현할 수는 없을까 생각해볼 수도 있겠습니다.</p>

<p>완성된 플러그인은 현재 <a href="https://www.npmjs.com/package/eslint-plugin-tidesquare">이곳</a> 에서 사용해보실 수 있습니다.
여러분의 프로젝트에서 한번 사용해보시고, 이 Rule에는 어떤 한계가 또 있는지, 다양한 피드백 부탁드립니다!</p>

<hr />

<h2 id="참고">참고</h2>

<ul>
  <li><a href="https://typescript-eslint.io/getting-started/">Typescript eslint 시작하기</a></li>
  <li><a href="https://typescript-eslint.io/blog/asts-and-typescript-eslint/">ASTs and typescript-eslint</a></li>
  <li><a href="https://v8.dev/blog/background-compilation">V8 엔진 컴파일러</a></li>
  <li><a href="https://yceffort.kr/2022/05/how-typescript-compiler-works">Typescript 컴파일러</a></li>
</ul>

        </div>
        <div class="back-button">
            <a href="/blog">목록으로</a>
        </div>
        <div class="fb-comments" data-href="https://squarelab.co/blog/custom-typescript-eslint-rule/" data-num-posts="4" data-width="100%"></div>
        <!--   <div class="side-bar">
    <div class="spacing"></div>
    <h5 class="title-category">CATEGORIES</h5>
    <p>
        <a href="/blog"> ALL</a>
        <span class="badge badge-theme pull-right"></span>
    </p>
    
    <p>
        <a href="/blog/#Engineering"> Engineering</a>
        <span class="badge badge-theme pull-right">13</span>
    </p>
    
    <p>
        <a href="/blog/#Design"> Design</a>
        <span class="badge badge-theme pull-right">4</span>
    </p>
    
    <p>
        <a href="/blog/#Interview"> Interview</a>
        <span class="badge badge-theme pull-right">4</span>
    </p>
    
    <p>
        <a href="/blog/#Travelog"> Travelog</a>
        <span class="badge badge-theme pull-right">1</span>
    </p>
    
    <p>
        <a href="/blog/#News"> News</a>
        <span class="badge badge-theme pull-right">2</span>
    </p>
    

    <div class="spacing"></div>
</div>

<div class="menu-wrap">
    <input type="checkbox" class="toggler">
    <div class="hamburger">
        <div></div>
    </div>
    <div class="menu">
        <div>
            <div>
                <a href="/index.html"><img src="/images/squarelab-bi-rec.png" width="32px" height="32px"
                                           class="menu-logo"></a>
                <p>
                    <a href="/blog">ALL</a>
                    <span class="badge badge-theme pull-right"></span>
                </p>
                
                <p>
                    <a href="/category/#Engineering"> Engineering</a>
                    <span class="badge badge-theme pull-right">13</span>
                </p>

                
                <p>
                    <a href="/category/#Design"> Design</a>
                    <span class="badge badge-theme pull-right">4</span>
                </p>

                
                <p>
                    <a href="/category/#Interview"> Interview</a>
                    <span class="badge badge-theme pull-right">4</span>
                </p>

                
                <p>
                    <a href="/category/#Travelog"> Travelog</a>
                    <span class="badge badge-theme pull-right">1</span>
                </p>

                
                <p>
                    <a href="/category/#News"> News</a>
                    <span class="badge badge-theme pull-right">2</span>
                </p>

                


            </div>
        </div>
    </div>
</div> 

  -->
    </div>
</div>
<script>(function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/ko_KR/sdk.js#xfbml=1&version=v2.5&appId=1052544885096271";
    fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<script src="/js/locale-date.js"></script>
  <!-- Footer -->
<footer id="footer">
    <div class="inner">
        <ul class="copyright">
            <li>&copy;
                Square Lab
            </li>
            <li>
                (주)스퀘어랩 | 서울특별시 중구 을지로5길 19, 페럼타워 24층<br>
                사업자등록번호 151-87-00987 | 통신판매업신고번호 2018-서울중구-1626호<br>
                이메일 contact@squarelab.co | 대표자 윤민
            </li>
        </ul>
        <div class="icons">
            <div class="icon"><a href="https://unsplash.com/@squarelab" target="_blank">
                <i class="ri-unsplash-fill"></i></a></div>
            <div class="icon"><a href="https://www.instagram.com/squarelab.co/" target="_blank">
                <i class="ri-instagram-line social"></i></a></div>
            <div class="icon"><a href="https://www.facebook.com/squarelab.co/" target="_blank">
                <i class="ri-facebook-circle-fill social"></i></a></div>
        </div>
    </div>
</footer>
  </body>
</html>