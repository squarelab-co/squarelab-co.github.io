<!DOCTYPE html>
<html lang="ko">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="description" content="여행과 기술을 연결하고, 사용자와 여행을 이어주는 스퀘어랩만의 노하우를 확인해 보세요.">
  <meta name="msapplication-TileColor" content="#782bde">
  <meta name="theme-color" content="#ffffff">
  <meta name="google-site-verification" content="-kdxteMBSgKizw-6qHNm1-5nfxb7H6947J64jmjbBEg" />

  <meta property="og:site_name" content="Square Lab 블로그">
  <meta property="og:title" content="K8s 클러스터에 Datadog 적용하기">
  <meta property="og:description" content="스퀘어랩에서는 각 microservice 별로 발생하는 로그들을 logstash를 활용하여 수집하고 있습니다. 이 과정에서 쌓이게 되는 수많은 로그들을 관리하는 비용을 줄이고, 서비스 모니터링과 로그 관리를 더욱...">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://squarelab.co/blog/datadog-poc/">
  <meta property="og:image" content="https://squarelab.co/images/blog/datadog-poc/cover.png">

  <title>K8s 클러스터에 Datadog 적용하기</title>

  <link rel="stylesheet" type="text/css" href="/css/blog.css">
  <link rel="stylesheet" type="text/css" href="/css/footer.css">
  <link rel="stylesheet" type="text/css" href="/css/zoom.css">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" rel="stylesheet">
  <link href='https://spoqa.github.io/spoqa-han-sans/css/SpoqaHanSansNeo.css' rel='stylesheet' type='text/css'>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/default.min.css" rel="stylesheet" >

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  출처: https://uxgjs.tistory.com/102 [UX 공작소]
  <script src="/js/zoom.js"></script>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-XPY973PH6D"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-XPY973PH6D');
  </script>
</head>
  <body>
  <header id="blog-header" class="header">
    <div class="blog-header-container">
        <a href="/blog">
          <img src="/images/squarelab-bi-blog.png" width="200" class="bi-blog" alt="스퀘어랩 기술블로그 로고">
        </a>
        <a href="/"><i class="ri-home-4-line"></i></a>
    </div>
</header>
  <div class="blog-container">
    <div class="blog-top" style="background-image:url(/images/blog/datadog-poc/datadog.png); background-size: cover;" >
        <div class="overlay">
            <div class="title-container">
                <span class="category">Engineering</span>
                <h1 class="ctitle-top">K8s 클러스터에 Datadog 적용하기</h1>
                <div class="author">
                    <img class="img-author-2" src="/images/blog/author/seongbin.png">
                    <small class="small-top" >성빈</small><small>|</small><small name="locale-date">Apr 24, 2023</small>
                </div>
            </div>
        </div>
    </div>
    <div class="blog-row">
        <div class="post">
            <p>스퀘어랩에서는 각 microservice 별로 발생하는 로그들을 logstash를 활용하여 수집하고 있습니다. 이 과정에서 쌓이게 되는 수많은 로그들을 관리하는 비용을 줄이고, 서비스 모니터링과 로그 관리를 더욱 편리하게 할 수 있다는 기대를 갖고 Datadog을 적용해보는 POC 기간을 갖게 되었습니다. 이 글은 Datadog 연동에 대한 관심이 있으신 분들에게 도움이 될 것 같습니다.</p>

<h2 id="datadog-적용-과정">Datadog 적용 과정</h2>
<p>K8s 클러스터에 Datadog을 적용하는 과정은 다음과 같이 세 단계로 요약할 수 있습니다.
Helm chart install → Deployment tagging / 환경변수 주입 → 재배포</p>

<p>prd 환경에 적용하기 위한 준비 단계로, 먼저 dev 환경에 Datadog을 적용해보았습니다.
dev와 prd cluster에서 각각 <code class="highlighter-rouge">values-dev.yaml</code> / <code class="highlighter-rouge">values-prd.yaml</code> 를 사용하도록 했습니다.</p>

<h3 id="datadog-helm-chart-install">Datadog helm chart Install</h3>
<p><code class="highlighter-rouge">helm install</code>이 성공적으로 마무리 되면, datadog-cluster 가 생성되고, k8s cluster의 각 노드별로 Datadog agent pod이 하나씩 생성되게 됩니다.
<a href="https://github.com/DataDog/helm-charts/blob/main/charts/datadog/values.yaml">여기</a>에서 values.yaml의 default 값을 참고하여, 필요한 부분만 골라서 yaml 파일을 작성했습니다.
처음 적용 과정에서 어떤 옵션이 필요한지 판단하기가 어려워 많은 시행착오를 거쳤고, 이 과정에서 겪은 시행착오들과, 처음 Datadog을 적용해보려는 분들에게 도움이 될 만한 내용들을 소개해드리겠습니다.</p>

<hr />

<h3 id="1-agent-version-불일치">1. Agent version 불일치</h3>
<p>처음에는 <code class="highlighter-rouge">values.yaml</code> 파일 내에 <code class="highlighter-rouge">clusterName</code> 등 필수 값과 사용할 기능들을 <code class="highlighter-rouge">enable: true</code>로 설정한 후, Datadog으로부터 발급받은 apiKey와 함께 <code class="highlighter-rouge">helm install</code> 을 진행했습니다.</p>

<p>이 때 아래와 같은 error가 발생했습니다.</p>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error: INSTALLATION FAILED: execution error at (datadog/templates/_helpers.tpl:17:4): This version of the chart requires an agent image 7.36.0 or greater. If you want to force and skip this check, use `--set agents.image.doNotCheckTag=true`
</code></pre></div></div>
<p>당시 <code class="highlighter-rouge">values.yaml</code> 내에 <code class="highlighter-rouge">tag</code> 를 설정해주지 않아서 발생했던 문제였습니다.
<code class="highlighter-rouge">clusterAgent.image.tag</code> / <code class="highlighter-rouge">agents.image.tag</code> / <code class="highlighter-rouge">clusterChecksRunner.image.tags</code> 에 동일한 값을 입력하여 해결했습니다.</p>

<hr />

<h3 id="2-env-주입--labelling">2. env 주입 / labelling</h3>
<blockquote>
  <p><a href="https://docs.datadoghq.com/tracing/other_telemetry/connect_logs_and_traces/nodejs/">Connecting Node.js Logs and Traces</a>
<a href="https://docs.datadoghq.com/tracing/trace_collection/library_config/nodejs/">Configuring the Node.js Tracing Library</a></p>
</blockquote>

<ol>
  <li>각 서비스별로 <code class="highlighter-rouge">DD_LOGS_INJECTION</code> 환경변수가 주입되면 Datadog은 console로 print 되는 로그들을 자동으로 수집합니다.</li>
  <li>별도의 설정 없이도 서비스의 env, service, version을 자동으로 발견합니다.
 Node의 경우에는 <code class="highlighter-rouge">package.json</code> 내에 있는 값을 참고하게 되는데, 이 값을 <code class="highlighter-rouge">package.json</code> 에서 관리할 수도 있지만, <code class="highlighter-rouge">env</code>의 경우는 cluster마다(또는 namespace마다) <code class="highlighter-rouge">version</code>의 경우에는 deployment가 배포될 때마다 변경되어야하므로 서비스별 yaml 파일의 metadata 부분에 값을 지정해서 관리하는 것이 편리했습니다.</li>
  <li>annotations 에서 JS 서비스인지, Java 서비스인지에 알맞게 library를 지정해주었습니다.
해당 서비스의 yaml 파일이 수정되었을 때, deployment를 재시작하여 반영상태를 확인할 수 있는데, 이 때 각 pod의 <code class="highlighter-rouge">datadog-lib-init</code> container가 정상적으로 실행/종료 되었어야합니다.</li>
</ol>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">deployment-name</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="s">...</span>
    <span class="s">tags.datadoghq.com/env</span><span class="pi">:</span> <span class="s">${ENV}</span> <span class="c1"># dev | qa | rc | prd</span>
    <span class="s">tags.datadoghq.com/service</span><span class="pi">:</span> <span class="s">service-name</span>
    <span class="s">tags.datadoghq.com/version</span><span class="pi">:</span> <span class="s">${VERSION}</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="s">...</span>
  <span class="s">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">annotations</span><span class="pi">:</span>
        <span class="s">...</span>
        <span class="s">admission.datadoghq.com/js-lib.version</span><span class="pi">:</span> <span class="s">v0.00.0</span>
        <span class="c1"># or admission.datadoghq.com/java-lib.version: v0.00.0</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">service-name</span>
          <span class="s">...</span>
          <span class="na">env</span><span class="pi">:</span>
              <span class="s">...</span>
            <span class="s">- name</span><span class="pi">:</span> <span class="s">DD_LOGS_INJECTION</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s1">'</span><span class="s">true'</span>
</code></pre></div></div>

<hr />

<h3 id="3-불필요한-log들을-indexing-대상에서-제외하기">3. 불필요한 log들을 indexing 대상에서 제외하기</h3>
<blockquote>
  <p><a href="https://docs.datadoghq.com/logs/explorer/search_syntax/">Log Search Syntax</a></p>
</blockquote>

<p>health check 와 같이 주기적으로 호출되는 log들은 status level이 info가 아닐 경우에만 수집하도록  indexing 대상에서 제외하면 요금을 절약할 수 있습니다.
<img src="/images/blog/datadog-poc/log_indexes.png" alt="Log Indexes" />
위 이미지는 Logs - Configuration - Indexes에서 kube_namespace가 dev / qa / rc / default(prd) 일 때 health check filtering 하는 부분만 나타냈습니다. 위와 같이 사진과 같이 필터를 적용할 수 있습니다. 필터는 상단에서 하단부로 내려가면서 차례대로 적용되며, 한번 filter 된 Log는 하위 필터에서 발견되지 않습니다. 그래서 상위 필터에서 너무 범용적인 조건을 걸면 하위 필터에서 해당 내용을 처리할 수가 없습니다.
<img src="/images/blog/datadog-poc/log_indexing_exclusion_filter.png" alt="Log Exclusion Filter" />
이 때, Exclusion Filter에서는 해당 필터 조건에 맞는 로그들을 제외시키기 때문에 execlusion operator(<code class="highlighter-rouge">-</code>)를 사용하면 오히려 indexing 대상이 됩니다. Datadog에서는 case sensitive 하게 query 하기 때문에, 위 이미지의 exclusion query 부분에서 확인할 수 있듯, uripath가 <code class="highlighter-rouge">health/Check</code> 와 <code class="highlighter-rouge">Health/check</code> 인 경우를 모두 고려할 수 있어야했습니다. <code class="highlighter-rouge">*</code> 를 사용해서 일부분을 matching 시킬 수는 있지만, 정규식의 case insensitive 옵션을 주듯이 할 수는 없었습니다. 위의 exclusion query에서 health check filtering 부분은 <code class="highlighter-rouge">?</code> 를 사용하여 조건을 <code class="highlighter-rouge">*?ealth/?heck</code> 와 같이 설정할 수도 있겠지만, 추후에 알아보기가 어려울 수 있을 것 같아 각각의 case를 모두 설정해주었습니다. <code class="highlighter-rouge">*[hH]ealth/[cC]heck</code> 와 같은 형태의 정규식으로 검색할 수 있으면 좋겠지만, 아쉽게도 search query 내부에서는 이런 정규식이 허용되지 않습니다.</p>

<p>Logs - Search에서는 여기서 설정한 <code class="highlighter-rouge">index</code> 그룹별로 로그를 확인할 수 있습니다.</p>

<hr />

<h3 id="4-log-pipeline">4. Log pipeline</h3>
<blockquote>
  <p><a href="https://docs.datadoghq.com/agent/logs/advanced_log_collection/?tab=configurationfile#global-processing-rules">Global processing rules</a></p>
</blockquote>

<p>Datadog은 기본적으로 console에 출력되는 로그를 그대로 가져옵니다. 기존에 Filebeat에서 사용하던 규칙을 그대로 datadog pipeline으로 옮기기 위해서는, 로그내의 정보를 조합해서 새로운 attribute를 만들거나, JSON 형식이 아닌 로그에 대해서는 <code class="highlighter-rouge">parser 적용</code> ➡️ <code class="highlighter-rouge">remapper 적용</code> 과정이 필요했습니다.</p>

<ul>
  <li>
    <p>서비스별로 사용하고 있는 logger의 종류에 따라 아래와 같이 remapper를 다르게 설정해주어야했습니다.
<img src="/images/blog/datadog-poc/log_pipeline.png" alt="Log Pipeline" /></p>
  </li>
  <li>로그의 date가 Datadog에서 처리된 시점으로 기록되어서, 적절한 시간대가 기록되지 않고 순서가 엉키는 경우가 있었습니다. <code class="highlighter-rouge">Date Remapper</code>를 사용해서 해당 로그에 기록되어있는 시간을 date로 사용하도록 했습니다.</li>
  <li>내부적으로 사용하고 있는 <code class="highlighter-rouge">grpc status code</code>를 Datadog에서 처리할 수 있는 level(<code class="highlighter-rouge">INFO</code> / <code class="highlighter-rouge">WARN</code> / <code class="highlighter-rouge">ERROR</code>)로 변형시키기 위해서 <code class="highlighter-rouge">Lookup Processor</code> ➡️ <code class="highlighter-rouge">Status Remapper</code> 를 적용했습니다.</li>
  <li>JSON 형태가 아니라, string으로 출력되는 로그의 경우 Level이 <code class="highlighter-rouge">INFO</code> 또는 <code class="highlighter-rouge">WARN</code>이어야하지만 <code class="highlighter-rouge">ERROR</code>로 설정되거나 또는 그 반대로 적용되는 경우가 있었습니다. 이  때는 <code class="highlighter-rouge">Grok Parser</code> ➡️ <code class="highlighter-rouge">Status Remapper</code> 를 적용했습니다. 아래 이미지는 error level 조정 전에 <code class="highlighter-rouge">INFO</code> 여야할 log들이 <code class="highlighter-rouge">ERROR</code>로 처리되다가 Remapping 적용 후 정상적으로 처리되고 있는 모습입니다.
  <img src="/images/blog/datadog-poc/log_search_status.png" alt="Log Status" /></li>
</ul>

<p>모든 로그를 이렇게 UI 상에서 필터링 해야하는 것은 아닙니다. yaml 파일 내부에 <code class="highlighter-rouge">exclude_at_match</code> 또는 <code class="highlighter-rouge">include_at_match</code> 에 정규식 패턴을 작성하여 Datadog으로 전송되지 않도록 global processing rule을 적용할 수 있습니다.
다만, json 형태의 로그에서 정규식으로 다양한 AND / OR 조건을 거는 것은 경제적이지 못하고, Datadog에서도 저장되는 로그의 양으로 비용을 계산하기 때문에 UI 상에서 pipeline과 filtering 조건을 거는 것이 낫겠다고 판단했습니다.</p>

<hr />

<h3 id="5-apm-tracing-대상에서-제외하기">5. APM tracing 대상에서 제외하기</h3>
<blockquote>
  <p><a href="https://docs.datadoghq.com/tracing/guide/ignoring_apm_resources/?tab=datadogyaml#trace-agent-configuration-options">Trace Agent configuration options</a></p>
</blockquote>

<p>Health check 와 같은 내용들은 로그 indexing은 해야하지만, trace 대상에서는 제외하는 것이 맞게다고 판단하여 resource를 기준으로 완전히 제외했습니다.</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">datadog</span><span class="pi">:</span>
  <span class="s">...</span>
  <span class="s">agents</span><span class="pi">:</span>
    <span class="s">...</span>
    <span class="s">containers</span><span class="pi">:</span>
      <span class="na">traceAgent</span><span class="pi">:</span>
        <span class="na">env</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">DD_APM_IGNORE_RESOURCES</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s">(?i)grpc\\.health\\.v1\\.Health\\/Check$</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">DD_APM_FILTER_TAGS_REQUIRE</code> / <code class="highlighter-rouge">DD_APM_FILTER_TAGS_REJECT</code> 환경변수를 부여해서 apm 대상에서 포함하거나 제외할 수 있습니다. 하지만, 각 조건들은 OR로 묶이고 정규식을 지원하지 않습니다.
<code class="highlighter-rouge">DD_APM_IGNORE_RESOURCES</code> 환경변수는 resource를 기준으로 정규식을 적용할 수 있어서 Health check 대상에서 위와 같이 제외했습니다.</p>

<hr />

<h3 id="6-secretbackend">6. secretBackend</h3>
<blockquote>
  <p><a href="https://docs.datadoghq.com/agent/guide/secrets-management/?tab=linux#script-for-reading-from-multiple-secret-providers">Script for reading from multiple secret providers</a></p>
</blockquote>

<p>k8s deployment yaml 파일을 작성하듯, Datadog helm chart를 install 할 때에도 클러스터에 입력되어있는 secret 값을 참고하고 싶었습니다. 이를 위해 Datadog에서는 secretBackend를 제공합니다.
Datadog apiKey 의 경우, <code class="highlighter-rouge">helm chart install / upgrade</code> 시 매번 입력하거나 해당 값을 그대로 파일 내에 입력해놓기보다는 secret 값을 참조하도록 하면 안전하게 값을 관리할 수 있겠습니다.</p>

<p>아래와 같이 secret을 생성했다면,</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create secret generic datadog-secret <span class="nt">--from-literal</span> api-key<span class="o">=</span><span class="s2">"api key from datadog"</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">values-dev.yaml</code>  에서는 아래와 같이 secretBackend command를 설정해주어야하며, 이로 인해 <code class="highlighter-rouge">ENC</code> 태그로 둘러쌓여있는 부분이 변환 될 수 있습니다.</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">datadog</span><span class="pi">:</span>
  <span class="na">apiKey</span><span class="pi">:</span> <span class="s">ENC[k8s_secret@dev/datadog-secret/api-key]</span>
  <span class="na">secretBackend</span><span class="pi">:</span>
    <span class="na">command</span><span class="pi">:</span> <span class="s1">'</span><span class="s">/readsecret_multiple_providers.sh'</span>
</code></pre></div></div>

<hr />

<h3 id="7-db-monitoring">7. DB Monitoring</h3>
<blockquote>
  <p><a href="https://docs.datadoghq.com/database_monitoring/setup_mysql/rds/?tab=mysql57">Setting Up Database Monitoring for Amazon RDS managed MySQL</a>
<a href="https://docs.aws.amazon.com/ko_kr/AmazonRDS/latest/UserGuide/Overview.DBInstance.Modifying.html">Amazon RDS DB 인스턴스 수정</a></p>
</blockquote>

<p>DB Monitoring을 적용할 때에도, <code class="highlighter-rouge">ENC</code>를 사용하여 secret 을 참조하도록 작성했습니다.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">datadog</span><span class="pi">:</span>
  <span class="s">...</span>
  <span class="s">clusterAgent</span><span class="pi">:</span>
    <span class="s">...</span>
    <span class="s">confd</span><span class="pi">:</span>
      <span class="s">mysql.yaml</span><span class="pi">:</span> <span class="pi">|-</span>
        <span class="s">cluster_check: true</span>
        <span class="s">init_config:</span>
        <span class="s">instances:</span>
          <span class="s">- dbm: true</span>
            <span class="s">host: ENC[k8s_secret@namespace/dbm-cred/host]</span>
            <span class="s">port: ENC[k8s_secret@namespace/dbm-cred/port]</span>
            <span class="s">username: ENC[k8s_secret@namespace/dbm-cred/username]</span>
            <span class="s">password: ENC[k8s_secret@namespace/dbm-cred/password]</span>
</code></pre></div></div>

<p>DBM 설정 과정은 다음과 같습니다.
DB parameter 설정 ➡️ datadog 계정 생성 / 권한 부여 ➡️ Agent 설치 ➡️ (optional) Datadog RDS Integration</p>

<p>Datadog 계정을 생성하고, Agent 설치까지 완료했으나, DB Monitoring이 활성화되지 않는 이슈가 있었습니다. agent 내에 dbm 설정이 제대로 되어있는지 확인하기 위해서는, node 별로 생성된 datadog-agent pod들 중 하나에서 <code class="highlighter-rouge">agent check mysql</code> 를 실행해보는 것이 필요했습니다. 이 때 해당 명령어로 확인할 수 있는 pod은 랜덤으로 지정되어서 불편한 점이 있었습니다.</p>

<p><code class="highlighter-rouge">agent check mysql</code> 을 실행해보니 아래와 같은 Warning이 확인되었습니다.</p>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>=========
Collector
=========
  Running Checks
  ==============
    mysql (x.x.x)
    --------------
      Instance ID: mysql:xxx [WARNING]
      Configuration Source: file:/etc/xxx/conf.d/mysql.yaml
      Total Runs: 1
      Metric Samples: Last Run: 88, Total: 88
      Events: Last Run: 0, Total: 0
      Service Checks: Last Run: 3, Total: 3
      Average Execution Time : 97ms
      Last Execution Date : 2023-03-30 06:47:33 UTC (1680158853000)
      Last Successful Execution Date : 2023-03-30 06:47:33 UTC (1680158853000)

      Warning: Unable to collect statement metrics because the performance schema is disabled. See &lt;https://docs.datadoghq.com/database_monitoring/setup_mysql/troubleshooting#performance-schema-not-enabled&gt; for more details
code=performance-schema-not-enabled host=&lt;RDS_HOST&gt;

      Warning: Query activity and wait event collection is disabled on this host. To enable it, the setup consumer `performance-schema-consumer-events-waits-current` must be enabled on the MySQL server. Please refer to the troubleshooting documentation: &lt;https://docs.datadoghq.com/database_monitoring/setup_mysql/troubleshooting#events-waits-current-not-enabled&gt;
code=events-waits-current-not-enabled host=&lt;RDS_HOST&gt;
</code></pre></div></div>

<p>문제는 DB parameter가 RDS 상에서 default mysql 값으로 지정되어있다보니, <code class="highlighter-rouge">performance_schema</code> 값이 0으로 되어있던 것이었습니다. <code class="highlighter-rouge">max_digest_length</code> / <code class="highlighter-rouge">performance_schema_max_diget_length</code> / <code class="highlighter-rouge">performance_schema_max_sql_text_length</code> 값들도 4096 으로 설정이 필요했습니다. 이후 파라미터 그룹을 적용하기 위해서는 DB를 수동으로 재시작해야 했습니다.</p>

<p><img src="/images/blog/datadog-poc/dbm_success.png" alt="DBM install success" />
DB를 재시작 하고 난 뒤, Database Monitoring이 성공적으로 set up 되었다는 기쁜 메시지를 확인할 수 있었습니다.</p>

<hr />

<h3 id="8-kotlin-서비스의-일부가-apm-catalog-목록에-뜨지-않는-경우">8. Kotlin 서비스의 일부가 APM catalog 목록에 뜨지 않는 경우</h3>
<p>Kotlin으로 작성한 프로젝트들 중 일부는 APM 목록에서 확인할 수가 없었고, 해당 에러는 socket 경로를 찾지 못했다는 것이었습니다.
<img src="/images/blog/datadog-poc/socket_not_found.png" alt="Socket Not Found Error" />
그러나 pod에 직접 접속하여 해당 경로를 확인해보면, <code class="highlighter-rouge">dsd.socket</code> 은 해당 경로에 존재하고 있었습니다.</p>

<p>문제가 되는 서비스들의 환경변수에 아래와 같이 <code class="highlighter-rouge">DD_DOGSTATSD_SOCKET</code> 을 추가해주었습니다.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- name: DD_DOGSTATSD_SOCKET
  value: <span class="s1">'/var/run/datadog/dsd.socket'</span>
</code></pre></div></div>

<p>그 후, pod을 재시작했을 때는 아래와 같이 <code class="highlighter-rouge">dsd.socket</code> 을 Detect 했다는 로그를 확인할 수 있고, 해당 서비스를 APM 목록에서 확인할 수 있었습니다.
<img src="/images/blog/datadog-poc/socket_found.png" alt="Socket Found" /></p>

<p>즉, socket 경로를 찾지 못해서 발생하는 버그로 판단됩니다.</p>

<hr />

<h3 id="9-trace-id가-제대로-연결되지-않음">9. Trace ID가 제대로 연결되지 않음</h3>
<blockquote>
  <p><a href="https://docs.datadoghq.com/tracing/trace_collection/open_standards/java/#opentracing">OpenTracing</a></p>
</blockquote>

<p><img src="/images/blog/datadog-poc/trace.png" alt="Traces" />
<img src="/images/blog/datadog-poc/trace_divided.png" alt="Trace Devided" />
Node.JS 서비스들에서는 잘 작동하지만, Node ➡️ Kotlin 프로젝트로 grpc request 가 진행될 때, <code class="highlighter-rouge">trace id</code> 가 이어지지 않고 새로운 <code class="highlighter-rouge">trace_id</code>가 부여되어서 별도의 span이 생기는 경우가 있었습니다.</p>

<p>기존에는 logging시 header에 <code class="highlighter-rouge">request_id</code> 정보가 있으면 해당 <code class="highlighter-rouge">request_id</code> 를 다음 request로 가져가고, 해당 정보가 없으면 새롭게 발급하여 log들 간 tracing을 하고 있었습니다.
APM trace 기능이 제대로 동작한다면, 편리하게 확인할 수 있는 상황이었기에, Log Pipeline에서 <code class="highlighter-rouge">Trace ID Remapper</code> 를 사용하면 간단하게 적용될 것으로 예상했었습니다.</p>

<p>그러나 Remapper를 적용하면 Log - Search에서는 <code class="highlighter-rouge">trace_id</code> attribute가 <code class="highlighter-rouge">request_id</code>로 변경된 것을 확인할 수 있지만, APM에서는 <code class="highlighter-rouge">trace_id</code> 가 그대로 <code class="highlighter-rouge">64 bits unsigned int</code> 형태로 존재했습니다.</p>

<p>Java 계열의 서비스는 <code class="highlighter-rouge">mdc</code> 내부에 <code class="highlighter-rouge">dd.trace_id</code> 가 주입되고 있어서 Log - Configuration의 <code class="highlighter-rouge">Preprocessing for JSON logs</code> 단계에서 <code class="highlighter-rouge">Trace Id attributes</code> 설정에 <code class="highlighter-rouge">mdc.dd.trace_id</code> 를 추가해야했습니다.</p>

<p>Datadog 측으로부터 현재 Node.JS와 Kotlin의 Framework를 아직 지원하고 있지 않기 때문에 auto instrumentation이 제대로 적용되지 않는 현상으로 확인하였고, 코드 단에서 header 정보를 Node.JS에서 추출하여 Kotlin(Java)로 주입하는 방법을 안내받았습니다.</p>

<p><a href="https://github.com/DataDog/dd-trace-java/releases">Datadog java trace GitHub repository</a>에서 잦은 release가 일어나고 있습니다. 어쩌면 코드 내부로 tracing관련 코드를 가져오는 것 보다는 auto instrumentation이 잘 작동하기를 기다리거나 해당 Repository에 직접 기여하는 것이 나을 수도 있겠습니다.</p>

<h2 id="마무리">마무리</h2>
<p>Datadog helm chart install시의 설정만 제대로 해준다면, k8s 환경에서 Datadog을 적용하는 것은 꽤나 편리했습니다. 기존에 logstash상에서 로그를 검색하면서 겪었던 불편함은 Datadog을 사용하면서 어느정도 해소될 수 있었습니다. 서비스별 monitor나 dashboard도 확인하기 편리하여, 트래픽이 몰리는 시점에 대비하여 deployment의 scale out을 진행할 때 모니터링 하기에도 유용했습니다.
비용과 사용성을 고려하여 dev cluster에서는 log indexing기능만 사용하고, prd에서는 APM이나 DB monitoring까지 적용해서 사용한다면 훨씬 경제적으로 log를 관리할 수 있을 것으로 기대됩니다.</p>

        </div>
        <div class="back-button">
            <a href="/blog">목록으로</a>
        </div>
        <div class="fb-comments" data-href="https://squarelab.co/blog/datadog-poc/" data-num-posts="4" data-width="100%"></div>
        <!--   <div class="side-bar">
    <div class="spacing"></div>
    <h5 class="title-category">CATEGORIES</h5>
    <p>
        <a href="/blog"> ALL</a>
        <span class="badge badge-theme pull-right"></span>
    </p>
    
    <p>
        <a href="/blog/#Engineering"> Engineering</a>
        <span class="badge badge-theme pull-right">7</span>
    </p>
    
    <p>
        <a href="/blog/#Design"> Design</a>
        <span class="badge badge-theme pull-right">4</span>
    </p>
    
    <p>
        <a href="/blog/#Interview"> Interview</a>
        <span class="badge badge-theme pull-right">3</span>
    </p>
    
    <p>
        <a href="/blog/#Travelog"> Travelog</a>
        <span class="badge badge-theme pull-right">1</span>
    </p>
    
    <p>
        <a href="/blog/#News"> News</a>
        <span class="badge badge-theme pull-right">2</span>
    </p>
    

    <div class="spacing"></div>
</div>

<div class="menu-wrap">
    <input type="checkbox" class="toggler">
    <div class="hamburger">
        <div></div>
    </div>
    <div class="menu">
        <div>
            <div>
                <a href="/index.html"><img src="/images/squarelab-bi-rec.png" width="32px" height="32px"
                                           class="menu-logo"></a>
                <p>
                    <a href="/blog">ALL</a>
                    <span class="badge badge-theme pull-right"></span>
                </p>
                
                <p>
                    <a href="/category/#Engineering"> Engineering</a>
                    <span class="badge badge-theme pull-right">7</span>
                </p>

                
                <p>
                    <a href="/category/#Design"> Design</a>
                    <span class="badge badge-theme pull-right">4</span>
                </p>

                
                <p>
                    <a href="/category/#Interview"> Interview</a>
                    <span class="badge badge-theme pull-right">3</span>
                </p>

                
                <p>
                    <a href="/category/#Travelog"> Travelog</a>
                    <span class="badge badge-theme pull-right">1</span>
                </p>

                
                <p>
                    <a href="/category/#News"> News</a>
                    <span class="badge badge-theme pull-right">2</span>
                </p>

                


            </div>
        </div>
    </div>
</div> 

  -->
    </div>
</div>
<script>(function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/ko_KR/sdk.js#xfbml=1&version=v2.5&appId=1052544885096271";
    fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<script src="/js/locale-date.js"></script>
  <!-- Footer -->
<footer id="footer">
    <div class="inner">
        <ul class="copyright">
            <li>&copy;
                Square Lab
            </li>
            <li>
                (주)스퀘어랩 | 서울특별시 중구 을지로5길 19, 페럼타워 24층<br>
                사업자등록번호 151-87-00987 | 통신판매업신고번호 2018-서울중구-1626호<br>
                이메일 contact@squarelab.co | 대표자 윤민
            </li>
        </ul>
        <div class="icons">
            <div class="icon"><a href="https://unsplash.com/@squarelab" target="_blank">
                <i class="ri-unsplash-fill"></i></a></div>
            <div class="icon"><a href="https://www.instagram.com/squarelab.co/" target="_blank">
                <i class="ri-instagram-line social"></i></a></div>
            <div class="icon"><a href="https://www.facebook.com/squarelab.co/" target="_blank">
                <i class="ri-facebook-circle-fill social"></i></a></div>
        </div>
    </div>
</footer>
  </body>
</html>